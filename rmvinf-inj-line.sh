#!/bin/bash

source /home/rlksvrlogs/scripts/dataset.sh

input=$1

function check_input() {
	username=$(cat /etc/trueuserowners | awk '{print $1}' | sed 's/://' | awk -v user=$input '{if ($1==user) print $1}')

	if [[ $input == "$username" ]]; then
		tempdata="/home/$username/backup/tempdata.txt"

		if [ -f $tempdata ]; then
			get_data

			infected_list

			rmv_infected
		else
			echo "File not found"
		fi
	else
		echo "Username not found"
	fi
}

function get_data() {

	filter=$(cat $tempdata | grep "FILTER=" | sed 's/FILTER=//')

	pattern=$(cat $tempdata | grep "PATTERN=" | sed 's/PATTERN=//')

	count=$(cat $tempdata | grep "COUNT=" | sed 's/COUNT=//')

}

function infected_list() {
	imunify-antivirus malware malicious list --user $username --limit 10000 | sed '1d' | awk '{$1=$2=$3=$4=$5=$6=$7=$(NF-9)=$(NF-8)=$(NF-7)=$(NF-6)=$(NF-5)=$(NF-4)=$(NF-3)=$(NF-2)=$NF=""; print}' | grep "SMW-INJ-" | sed 's/^[[:space:]]*//' >>$temp/$username-inf-inj_$time.txt
}

function rmv_infected() {
	if [ -r $temp/$username-inf-inj_$time.txt ] && [ -s $temp/$username-inf-inj_$time.txt ]; then

		while IFS= read -r line || [[ -n "$line" ]]; do
			file=$(echo "$line" | awk '{$NF=""; print}' | sed 's/[[:blank:]]*$//')
			type=$(echo "$line" | awk '{print $NF}')

			if [[ $type == "$filter" ]]; then
				start=$(cat $file | fgrep -n "$pattern" | awk -F':' '{print$1}')

				last=$(sed -n '$=' $file)

				if [[ ! -z $start && $start -ne 0 ]]; then
					end=$(echo "$start" | awk -v num=$start -v count=$count 'BEGIN {sum=num+count ; print sum}')

					sed -i "${start},${end}d" $file

					nlast=$(sed -n '$=' $file)

					if [[ $nlast -lt $last ]]; then
						echo "Modified - $start - $end - $file - $type" >>$svrlogs/malware/$username-inf-inj_$time.txt
					else
						echo "Not Modified - $start - $end - $file - $type" >>$svrlogs/malware/$username-inf-inj_$time.txt
					fi
				else
					echo "Failed - $file - $type" >>$svrlogs/malware/$username-inf-inj_$time.txt
				fi
			fi

		done <"$temp/$username-inf-inj_$time.txt"
	fi
}

check_input
